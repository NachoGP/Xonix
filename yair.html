<html>

<head>
<title>HTML5 XoniX</title>

<style>
    #canvas { background:#00A8A8; }
</style>

<script type="text/javascript" src="scripts/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="scripts/point.js"></script>
<script type="text/javascript" src="scripts/edge.js"></script>
<script type="text/javascript" src="scripts/path.js"></script>
<script type="text/javascript" src="scripts/vector.js"></script>
<script type="text/javascript" src="scripts/event_handler.js"></script>
<script type="text/javascript" src="scripts/movable.js"></script>
<script type="text/javascript" src="scripts/slice.js"></script>
<script type="text/javascript" src="scripts/circle.js"></script>
<script type="text/javascript" src="scripts/rectangle.js"></script>
<script type="text/javascript" src="scripts/polygon.js"></script>
<script type="text/javascript" src="scripts/ball.js"></script>
<script type="text/javascript" src="scripts/monster.js"></script>
<script type="text/javascript" src="scripts/player.js"></script>

<script>
    var canvasWidth = 600,
            canvasHeight = 400,
            frameBorder = 18,
            totalPixels,
            conquredPixels,
            freePixels;
    var numOfBalls = 4,
            numOfMonsters = 2;
    var player,
            arrFree = [],
            arrConquered = [],
            arrBalls = [],
            arrMonsters = [];
    var playerSize = 9,
            ballSize = 9,
            monsterSize = 9,
            trackSize = 9;

    function initGame() {
        arrFree = [];
        arrConquered = [];
        arrBalls = [];
        arrMonsters = [];
        totalPixels = (canvasWidth - frameBorder) * (canvasHeight - frameBorder);
        conquredPixels = 0;
        freePixels = totalPixels - conquredPixels;

        //create start free area
        var free = new Polygon([
            new Point(frameBorder, frameBorder),
            new Point(canvasWidth - frameBorder, frameBorder),
            new Point(canvasWidth - frameBorder, canvasHeight - frameBorder),
            new Point(frameBorder, canvasHeight - frameBorder)
        ]);
        arrFree.push(free);

        //create player
        var speed = 2;
        var velocityX = speed * 1;
        var velocityY = speed * 1;
        var boundary = { top: 0, left: 0, right: canvasWidth, bottom: canvasHeight };
        player = new Player(0, 0, playerSize, 'White', '#901290', new Vector(velocityX, velocityY), boundary);

        //create balls
        for (var i = 0; i < numOfBalls; i++) {
            var x = random(frameBorder*2, canvasWidth - frameBorder*2);
            var y = random(frameBorder*2, canvasHeight - frameBorder*2);
            var speed = 2;
            var velocityX = speed * (random(0, 1) == 0 ? -1 : 1);
            var velocityY = speed * (random(0, 1) == 0 ? -1 : 1);

            var top = frameBorder;
            var right = canvasWidth - frameBorder;
            var bottom = canvasHeight - frameBorder;
            var left = frameBorder;
            var boundary = new Rectangle(left, top, right, bottom); //{ top: frameBorder, left: frameBorder, right: canvasWidth - frameBorder, bottom: canvasHeight - frameBorder }

            var ball = new Ball(x, y, ballSize/2, '#00A8A8', 'White', new Vector(velocityX, velocityY), boundary, arrConquered);
            arrBalls.push(ball);
        }

        //create monsters
        for (var i = 0; i < numOfMonsters; i++) {
            var left = random(0, canvasWidth - monsterSize);
            var top = random(canvasHeight - frameBorder, canvasHeight - monsterSize);
            var speed = 2;
            var velocityX = speed * (random(0, 1) == 0 ? -1 : 1);
            var velocityY = speed * (random(0, 1) == 0 ? -1 : 1);
            var boundary = { top: 0, left: 0, right: canvasWidth, bottom: canvasHeight };
            var monster = new Monster(left, top, monsterSize, '#00A8A8', 'Black', new Vector(velocityX, velocityY), boundary, arrFree);
            arrMonsters.push(monster);
        }
    }
    function drawArray(ctx, array, fillStyle, strokeStyle) {
        for (var i=0; i<array.length; i++) {
            var obj = array[i];
            obj.draw(ctx, fillStyle);
        }
    }
    function random(min, max) {
        var val = min + Math.random() * (max - min);
        return Math.round(val);
    }

    function get_random_color() {
        var letters = '0123456789ABCDEF'.split('');
        var color = '#';
        for (var i = 0; i < 6; i++ ) {
            color += letters[Math.round(Math.random() * 15)];
        }
        return color;
    }

    $(document).ready(function() {
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");

        var polygons = [];
        var pol = new Polygon();
        pol.addPoint(new Point(100, 0));
        pol.addPoint(new Point(100, 200));
        pol.addPoint(new Point(200, 200));
        pol.addPoint(new Point(200, 400));
        pol.addPoint(new Point(150, 400));
        pol.addPoint(new Point(150, 500));
        pol.addPoint(new Point(210, 500));
        pol.addPoint(new Point(210, 190));
        pol.addPoint(new Point(110, 190));
        pol.addPoint(new Point(110, 0));

        var rectangles = pol.get_rectangles(new Vector(1,0));

        for (var i=0; i<rectangles.length; i++)
        {
            rectangles[i].draw(ctx, get_random_color());
        }

        initGame();

        //create DEBUG track
        var tracks = [];
        var paths = [];

        tracks[0] = new Polygon([   // DOWN
            new Point(200 - (trackSize/2), frameBorder),
            new Point(200 + (trackSize/2), frameBorder),
            new Point(200 + (trackSize/2), 100 - (trackSize/2)),
            new Point(300 + (trackSize/2), 100 - (trackSize/2)),
            new Point(300 + (trackSize/2), 200 + (trackSize/2)),
            new Point(260 + (trackSize/2), 200 + (trackSize/2)),
            new Point(260 + (trackSize/2), canvasHeight - frameBorder),
            new Point(260 - (trackSize/2), canvasHeight - frameBorder),
            new Point(260 - (trackSize/2), 200 - (trackSize/2)),
            new Point(300 - (trackSize/2), 200 - (trackSize/2)),
            new Point(300 - (trackSize/2), 100 + (trackSize/2)),
            new Point(200 - (trackSize/2), 100 + (trackSize/2))
        ]);
        paths[0] = new Path([       // DOWN (INNER)
            new Point(200 - (trackSize/2), frameBorder),
            new Point(200 - (trackSize/2), 100 + (trackSize/2)),
            new Point(300 - (trackSize/2), 100 + (trackSize/2)),
            new Point(300 - (trackSize/2), 200 - (trackSize/2)),
            new Point(260 - (trackSize/2), 200 - (trackSize/2)),
            new Point(260 - (trackSize/2), canvasHeight - frameBorder)
        ]);
        paths[4] = new Path([       // DOWN (OUTER)
            new Point(200 + (trackSize/2), frameBorder),
            new Point(200 + (trackSize/2), 100 - (trackSize/2)),
            new Point(300 + (trackSize/2), 100 - (trackSize/2)),
            new Point(300 + (trackSize/2), 200 + (trackSize/2)),
            new Point(260 + (trackSize/2), 200 + (trackSize/2)),
            new Point(260 + (trackSize/2), canvasHeight - frameBorder)
        ]);
        var rnd = random(0, 0);
        var trackPoly = tracks[rnd];
        var innerPath = paths[rnd];
        var outerPath = paths[rnd + 4];

        //split
        var result = [];
        var firstPoly = arrFree[0].split(innerPath)[0];
        var secondPoly = arrFree[0].split(outerPath)[1];
        result.push(firstPoly);
        result.push(secondPoly);

        arrFree = []; // todo: remove only the polygon that we split
        for (var i=0; i<result.length; i++) {
            var poly = result[i];
            var containsBall = false;
            for (var b=0; b<arrBalls.length; b++) {
                if (poly.containsPoint(arrBalls[b])) {
                    containsBall = true;
                    break;
                }
            }
            if (containsBall) {
                arrFree.push(poly);
            } else {
                arrConquered.push(poly);
                size = Math.abs(poly.getArea());
                freePixels -= size;
                conquredPixels += size;
            }
        }
        arrConquered.push(trackPoly);
        size = Math.abs(trackPoly.get_area());
        freePixels -= size;
        conquredPixels += size;

        console.log('total:' + totalPixels + ' ' + 'conqured:' + conquredPixels + ' ' + 'free:' + freePixels + ' => ' + conquredPixels/totalPixels*100 + '%');
        console.log('direction:' + innerPath.get_direction());

        console.log('free:' + arrFree.length);
        console.log('conquered:' + arrConquered.length);

        function update() {
            player.step();

            for (var ball in arrBalls) {
                arrBalls[ball].obstacles = arrConquered;
                arrBalls[ball].step();
            }
            for (var monster in arrMonsters) {
                arrMonsters[monster].obstacles = arrFree;
                arrMonsters[monster].step();
            }
        }

        function draw() {
            drawArray(ctx, arrFree, 'Black');
            //drawArray(ctx, arrConquered, '#00A8A8');
            //trackPoly.draw(ctx, 'Green');
            drawArray(ctx, arrBalls);
            drawArray(ctx, arrMonsters);
            player.draw(ctx);
        }

        setInterval(function () {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            update();
            draw();
        }, 1000 / 50);
    });
</script>
</head>

<body>
<canvas id="canvas" width="600" height="500"></canvas>
</body>

</html>